"use strict";angular.module("charagarApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngDialog","angular-lodash","ui.router","ngFileUpload","ngImgur","ng.httpLoader","ngImgCrop"]).run(["userService","$rootScope",function(a,b){function c(){a.doesTokenExist()&&a.verifyToken().then(function(a){console.log("verified token")},function(a){console.log("token not authorized")})}b.$on("$stateChangeStart",function(b,d){a.isLoggedIn()||c()})}]).config(["$stateProvider","$urlRouterProvider","$httpProvider","httpMethodInterceptorProvider",function(a,b,c,d){d.whitelistDomain("api.imgur.com"),c.interceptors.push("authInterceptor"),b.otherwise("/home"),a.state("home",{url:"/home",templateUrl:"views/main.html",controller:"MainCtrl"}).state("about",{url:"/about",templateUrl:"views/about.html",controller:"AboutCtrl"}).state("startCampaign",{url:"/startCampaign",templateUrl:"views/startCampaign.html",controller:"StartcampaignCtrl"}).state("detailedCampaign",{url:"/campaign/:campaignId",templateUrl:"views/detailedCampaign.html",controller:"DetailedcampaignCtrl"}).state("general",{url:"/general",templateUrl:"views/general.html",controller:"GeneralCtrl"}).state("generalZakaatFund",{url:"/generalZakaatFund",templateUrl:"views/zakaatFund.html",controller:"ZakaatfundCtrl"}).state("generalFund",{url:"/generalFund",templateUrl:"views/generalFund.html",controller:"GeneralfundCtrl"}).state("myContributions",{url:"/myContributions",templateUrl:"views/myContributions.html",controller:"MycontributionsCtrl"}).state("myCampaigns",{url:"/myCampaigns",templateUrl:"views/myCampaigns.html",controller:"MycampaignsCtrl"}).state("editCampaign",{url:"/editCampaign/:campaignId",templateUrl:"views/editCampaign.html",controller:"EditcampaignCtrl"}).state("reviewCampaigns",{url:"/reviewCampaigns",templateUrl:"views/reviewCampaigns.html",controller:"ReviewcampaignsCtrl"}).state("browseCampaigns",{url:"/browseCampaigns",templateUrl:"views/browseCampaigns.html",controller:"BrowsecampaignsCtrl"})}]),angular.module("charagarApp").controller("MainCtrl",["$scope","campaignService",function(a,b){function c(){b.getLiveCampaigns().then(function(b){a.liveCampaigns=b,0!=a.liveCampaigns.length&&(a.liveCampaignsLoaded=!0)}),b.getPastCampaigns().then(function(b){a.pastCampaigns=b,0!=a.pastCampaigns.length&&(a.pastCampaignsLoaded=!0)})}a.liveCampaignsLoaded=!1,a.pastCampaignsLoaded=!1,c()}]),angular.module("charagarApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("charagarApp").controller("HeaderCtrl",["$scope","ngDialog","userService",function(a,b,c){function d(){a.isLoggedIn=c.isLoggedIn(),a.userData=c.getUserInfo()}a.$watch(c.isLoggedIn,function(b){b&&(a.userData=c.getUserInfo()),a.isLoggedIn=b}),a.openSignup=function(){b.open({template:"views/userAuth.html",controller:"UserauthCtrl",className:"ngdialog-theme-default userAuth",showClose:!0,closeByEscape:!0,closeByDocument:!0})},a.logoutUser=function(){c.logoutUser()},a.dropdown=[{text:"Logout",click:"logoutUser()"},{text:"My Campaigns",click:""}],d()}]),angular.module("charagarApp").controller("UserauthCtrl",["$scope","userService","ngDialog",function(a,b,c){function d(b){a.state={isSignup:b,errorMsg:"",isSubmitting:!1,isLoading:!1},a.userData={username:"",email:"",password:""}}a.isError=!1,a.state={},a.user={},a.loginUser=function(){a.isError=!1,a.state.isLoading=!0,b.loginUser(angular.copy(a.user)).then(function(b){a.closeThisDialog(),a.state.isLoading=!1},function(b){a.isError=!0,console.log("ERROR:",b),a.state.isLoading=!1,a.state.errorMsg=b.data.error_body})},a.switchView=function(a){d(a)},a.signupUser=function(c){a.isError=!1,a.isLoading=!0,b.signupUser(angular.copy(a.user)).then(function(b){a.isLoading=!1,a.closeThisDialog()},function(b){a.state.isLoading=!1,a.state.errorMsg=b.data.error_body,a.isError=!0})}}]),angular.module("charagarApp").service("userService",["configConstants","$http","$rootScope","$window",function(a,b,c,d){function e(a){var b=a.replace("-","+").replace("_","/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw"Illegal base64url string!"}return window.atob(b)}function f(a){return md5(a)}var g=a.apiPrefix,h=a.authorizedApiPrefix;this.loginUser=function(a){a.password=f(a.password);var c=this;return b.post(g+"loginUser/",a).then(function(a){return d.sessionStorage.token=a.data.token,c.getUserInfoDataFromToken(a.data.token),d.sessionStorage.isLoggedIn=!0,a.data})},this.getUserInfoDataFromToken=function(a){var b=a.split(".")[1],c=JSON.parse(e(b)),f={email:c.email,userId:c._id,name:c.name,accessLevel:c.accessLevel};d.sessionStorage.userData=angular.toJson(f)},this.doesTokenExist=function(){return d.sessionStorage.token?!0:!1},this.isLoggedIn=function(){return d.sessionStorage.isLoggedIn?d.sessionStorage.isLoggedIn:"false"},this.logoutUser=function(){d.sessionStorage.isLoggedIn=!1,d.sessionStorage.userData=null,delete d.sessionStorage.token},this.getUserInfo=function(){return d.sessionStorage.userData?JSON.parse(d.sessionStorage.userData):void 0},this.getUserPermissions=function(){return JSON.parse(d.sessionStorage.userData).accessLevel},this.signupUser=function(a){var c=a.password;a.accessLevel="user",a.password=f(a.password);var d=this;return b.post(g+"signupUser",a).then(function(b){var e={email:a.email,password:c};d.loginUser(e)})},this.verifyToken=function(){return b.get(h+"verifyToken").then(function(a){})}}]),angular.module("charagarApp").constant("configConstants",{apiPrefix:"https://charagar.herokuapp.com/",authorizedApiPrefix:"https://charagar.herokuapp.com/api/v1/",adminApiPrefix:"https://charagar.herokuapp.com/api/v1/admin/",userApiPrefix:"https://charagar.herokuapp.com/api/v1/user/",imgurClientID:"4c8a0a606234adf",imgurClientSecret:"2b63ec31c9df5fbcd561e4e81b68b0c1db8b4889"}),angular.module("charagarApp").controller("MasterCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("charagarApp").controller("StartcampaignCtrl",["$scope","campaignService","userService","ngDialog","$timeout","configConstants","$http","$q",function(a,b,c,d,e,f,g,h){}]),angular.module("charagarApp").service("campaignService",["userService","$http","configConstants",function(a,b,c){var d=c.apiPrefix,e=c.authorizedApiPrefix,f=c.adminApiPrefix,g=c.userApiPrefix;this.saveCampaign=function(a){var c={campaign:a};return b.post(e+"saveCampaign/",c).then(function(a){})},this.getLiveCampaigns=function(){return b.get(d+"getLiveCampaigns").then(function(a){return a.data})},this.getPastCampaigns=function(){return b.get(d+"getPastCampaigns").then(function(a){return a.data})},this.getAllCampaigns=function(){return b.get(d+"getAllCampaigns").then(function(a){return a.data})},this.getCampaign=function(a){return b.get(d+"getCampaign/"+a).then(function(a){return a.data})},this.getZakaatFund=function(){return b.get(d+"getZakaatFund").then(function(a){return a.data})},this.getGeneralFund=function(){return b.get(d+"getGeneralFund").then(function(a){return a.data})},this.getCampaignsForUser=function(a){return console.log("USERIDDDDDXXX:",a),b.post(g+"getCampaignsForUser",a).then(function(a){return a.data})},this.getContributionsForUser=function(a){return b.post(g+"getContributionsForUser/",a).then(function(a){return a.data})},this.getCampaignsByCategory=function(a){return b.post(d+"getCampaignsByCategory/",a).then(function(a){return a.data})},this.editCampaign=function(a){return b.post(f+"editCampaign/",a).then(function(a){return a.data})},this.deleteCampaign=function(a){return console.log("PARAMZ:",a),b.post(f+"deleteCampaign/",a).then(function(a){return a.data})},this.requestDeletion=function(a){return b.post(g+"requestDeletion/",a).then(function(a){return a.data})}}]),angular.module("charagarApp").directive("campaignDirective",["campaignService","userService","ngDialog","$timeout",function(a,b,c,d){return{templateUrl:"scripts/directives/templates/campaign.html",restrict:"E",scope:{data:"=",admin:"=",contributions:"=",mine:"="},controller:["$scope",function(e){function f(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}e.campaignData=e.data,e.campaignData.name&&(e.campaignData.name=f(e.campaignData.name)),e.percentageRaised=e.campaignData.amountRaised/e.campaignData.goal*100,console.log("percentageRaised:",e.percentageRaised),moment(e.campaignData.endDate).isBefore(new Date)||(e.timeLeft=f(moment(e.campaignData.endDate).fromNow(!0))+" Left"),e.getHref=function(){return"#!/campaign/"+e.campaignData._id},e.getEditHref=function(){return console.log("#!/editCampaign/"+e.campaignData._id),"#!/editCampaign/"+e.campaignData._id},e.requestDeletion=function(){c.openConfirm({template:"views/confirmDelete.html",className:"ngdialog-theme-default",scope:e}).then(function(f){var g={campaignId:e.campaignData._id,userId:b.getUserInfo().userId};console.log("INPUT is good sometimes:",g),a.requestDeletion(g).then(function(a){d(function(){c.open({template:"<div> Submitted for deletion.</div>",plain:!0})},500)},function(a){d(function(){c.open({template:"<div>Oops! Unable to request deletion. Try again</div>",plain:!0})},500)})},function(a){})}}],link:function(a,b,c){}}}]),angular.module("charagarApp").controller("DetailedcampaignCtrl",["$scope","$stateParams","campaignService",function(a,b,c){function d(){a.campaign,a.percentageRaised,a.canLoadVideo=!1,a.loadCampaignDetail()}function e(a){var b=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,c=a.match(b);return c&&11==c[2].length?c[2]:"error"}var f=b.campaignId,g="error";a.loadCampaignDetail=function(){c.getCampaign(f).then(function(b){a.campaign=b[0],a.percentageRaised=a.campaign.amountRaised/a.campaign.goal*100,a.timeLeft=moment(a.campaign.endDate).fromNow(!0),a.isLive=moment(new Date).isBefore(moment(a.campaign.endDate)),console.log("CAMPAIN:",a.campaign),a.campaign.video&&(g=e(a.campaign.video)),"error"!=g&&(a.canLoadVideo=!0,$("#videoPlayer").html('<iframe class="video" width="560" height="315" src="//www.youtube.com/embed/'+g+'" frameborder="0" allowfullscreen></iframe>'))},function(a){})},d()}]),angular.module("charagarApp").controller("GeneralfundCtrl",["campaignService","$scope",function(a,b){function c(){a.getGeneralFund().then(function(a){b.campaign=a[0],e=d(b.campaign.video),"error"!=e&&(b.canLoadVideo=!0,$("#videoPlayer").html('<iframe class="video" width="560" height="315" src="//www.youtube.com/embed/'+e+'" frameborder="0" allowfullscreen></iframe>'))})}function d(a){var b=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,c=a.match(b);return c&&11==c[2].length?c[2]:"error"}var e="";b.canLoadVideo=!1,c()}]),angular.module("charagarApp").controller("ZakaatfundCtrl",["$scope","campaignService",function(a,b){function c(){b.getZakaatFund().then(function(b){a.campaign=b[0],e=d(a.campaign.video),"error"!=e&&(a.canLoadVideo=!0,$("#videoPlayer").html('<iframe class="video" width="560" height="315" src="//www.youtube.com/embed/'+e+'" frameborder="0" allowfullscreen></iframe>'))})}function d(a){var b=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,c=a.match(b);return c&&11==c[2].length?c[2]:"error"}var e="";a.canLoadVideo=!1,c()}]),angular.module("charagarApp").controller("GeneralCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("charagarApp").controller("MycontributionsCtrl",["campaignService","userService","$scope",function(a,b,c){function d(){var d={userId:b.getUserInfo().userId};c.contributionsLoaded=!1,a.getContributionsForUser(d).then(function(a){c.campaigns=a,c.contributionsLoaded=!0,console.log("CONTRIBUTIONS:",c.campaigns)})}c.getHref=function(a){return console.log("GETTING HREF"),"#!/campaign/"+a._id},d()}]),angular.module("charagarApp").controller("MycampaignsCtrl",["$scope","userService","campaignService",function(a,b,c){function d(){a.campaignsLoaded=!1;var d={userId:b.getUserInfo().userId};console.log("useSERVICE IFNO:",b.getUserInfo()),c.getCampaignsForUser(d).then(function(b){a.campaigns=b,a.campaignsLoaded=!0})}d()}]),angular.module("charagarApp").controller("EditcampaignCtrl",["campaignService","$stateParams","$scope","$timeout","ngDialog","userService",function(a,b,c,d,e,f){function g(){"admin"==f.getUserPermissions()?c.loadCampaignDetail():c.canAccess=!1}c.campaign=null;var h=b.campaignId;c.canAccess=!0,c.loaded=!1,c.loadCampaignDetail=function(){a.getCampaign(h).then(function(a){c.campaign=a[0],c.campaign.startDate=new Date(c.campaign.startDate),c.campaign.endDate=new Date(c.campaign.endDate),c.loaded=!0},function(a){})},g()}]),angular.module("charagarApp").controller("ReviewcampaignsCtrl",["campaignService","$scope","userService",function(a,b,c){function d(){b.campaignsLoaded=!1,"admin"==c.getUserInfo().accessLevel&&a.getAllCampaigns().then(function(a){b.campaigns=a,b.campaignsLoaded=!0})}d()}]),angular.module("charagarApp").controller("BrowsecampaignsCtrl",["campaignService","$scope",function(a,b){function c(){a.getCampaignsByCategory({}).then(function(a){b.campaigns=a,b.campaignsLoaded=!0})}b.categories=["Health","Education","All"],b.selectedCategory="All",b.campaignsLoaded=!1,c(),b.categoryChanged=function(){var c={};"All"!=b.selectedCategory&&(c={category:b.selectedCategory}),b.campaignsLoaded=!1,a.getCampaignsByCategory(c).then(function(a){b.campaigns=a,b.campaignsLoaded=!0})}}]),angular.module("charagarApp").factory("authInterceptor",["$rootScope","$q","$window","$location","configConstants",function(a,b,c,d,e){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&a.url.indexOf("api.imgur.com")<0&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},responseError:function(a){return 401===a.status,b.reject(a)}}}]),angular.module("charagarApp").directive("campaignFormDirective",function(){return{templateUrl:"scripts/directives/templates/campaignForm.html",restrict:"E",scope:{data:"=",admin:"@"},controller:["$scope","campaignService","userService","ngDialog","$timeout","configConstants","$http","$q","$state",function(a,b,c,d,e,f,g,h,i){function j(){l(),a.admin?a.campaign=a.data:a.campaign={creator:"",isApproved:!1,isZakaat:!1,type:"Individual",amountRaised:0},a.campaignTypes=["Individual","Cause"],a.categoryTypes=["Health","Education"],a.uploadImages={campaignImageFile:null,croppedImageFile:null},a.saveStatus=""}function k(){var b=h.defer();a.saveStatus="Uploading...";g({headers:{Authorization:"Client-ID 4c8a0a606234adf"},url:"https://api.imgur.com/3/image",method:"POST",data:{image:a.uploadImages.croppedImageFile.split(",")[1]}}).then(function(c){a.saveStatus="Done",b.resolve(c.data.data.link)},function(c){b.reject(c),a.saveStatus="Error! Try Again"});return b.promise}function l(){var a=new Date,b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();10>b&&(b="0"+b),10>c&&(c="0"+c),a=d+"-"+c+"-"+b,document.getElementById("startdatefield").setAttribute("min",a),document.getElementById("enddatefield").setAttribute("min",a)}j(),a.saveCampaign=function(){a.campaign.creator=c.getUserInfo().userId,a.campaign.isApproved=!1,a.campaign.amountRaised=0,k().then(function(c){a.campaign.image=c,b.saveCampaign(angular.copy(a.campaign)).then(function(a){e(function(){j(),d.open({template:"<div>You campaign has been submitted for approval.</div>",plain:!0})},500)},function(a){e(function(){j(),d.open({template:"<div>Oops! Unable to submit campaign.</div>",plain:!0})},500)})})},a.editCampaign=function(){if(a.uploadImages.croppedImageFile)k().then(function(c){a.campaign.image=c;var f={campaignId:a.campaign._id,campaign:a.campaign};b.editCampaign(f).then(function(a){e(function(){j(),d.open({template:"<div> This campaign has been edited.</div>",plain:!0})},500)},function(a){e(function(){j(),d.open({template:"<div>Oops! Unable to edit campaign.</div>",plain:!0})},500)})});else{var c={campaignId:a.campaign._id,campaign:a.campaign};b.editCampaign(c).then(function(a){e(function(){j(),d.open({template:"<div> This campaign has been edited.</div>",plain:!0})},500)},function(a){e(function(){j(),d.open({template:"<div>Oops! Unable to edit campaign.</div>",plain:!0})},500)})}},a.deleteCampaign=function(){d.openConfirm({template:"views/confirmDelete.html",className:"ngdialog-theme-default",scope:a}).then(function(c){var f={campaignId:a.campaign._id};b.deleteCampaign(f).then(function(a){e(function(){j(),d.open({template:"<div> This campaign has been deleted.</div>",plain:!0})},500),i.go("reviewCampaigns")},function(a){e(function(){j(),d.open({template:"<div>Oops! Unable to delete.</div>",plain:!0})},500)})},function(a){})},a.isSaveDisabled=function(){return a.uploadImages.croppedImageFile?"Uploading..."==a.saveStatus?!0:a.signup_form.$invalid?!0:void 0:!0},a.isEditDisabled=function(){return"Uploading..."==a.saveStatus?!0:a.signup_form.$invalid?!0:void 0},a.onImageSelect=function(b,c){var d=b[0];a.file=d;var e=new FileReader;e.onload=function(b){var c=new Image;c.src=e.result,c.onload=function(){a.$apply(function(a){a.uploadImages.campaignImageFile=b.target.result})}},e.readAsDataURL(d)},a.restrictEndDate=function(){if(a.campaign.startDate){var b=a.campaign.startDate,c=a.campaign.startDate.getDate(),d=a.campaign.startDate.getMonth()+1,e=a.campaign.startDate.getFullYear();10>c&&(c="0"+c),10>d&&(d="0"+d),b=e+"-"+d+"-"+c,document.getElementById("enddatefield").setAttribute("min",b)}}}],link:function(a,b,c){}}}),angular.module("charagarApp").directive("campaignDisplay",function(){return{templateUrl:"scripts/directives/templates/campaignDisplay.html",restrict:"E",scope:{data:"=",name:"@",contributions:"@",mine:"@",admin:"@"},controller:["$scope",function(a){console.log("HEREEEEEE:",a.mine),a.campaigns=a.data}],link:function(a,b,c){}}});